(()=>{"use strict";const{useState:e,useEffect:r,useRef:n,useCallback:t}=wp.element,o=window.ReactJSXRuntime,{useEffect:a,useState:s,useRef:i,useCallback:c}=wp.element,l=l=>{const{responseTypes:d}=l.emitResponse,{onPaymentSetup:u,onCheckoutValidation:m,onCheckoutSuccess:p}=l.eventRegistration,h=l.moneiData||wc.wcSettings.getSetting("monei_data"),g="yes"===h.redirect,y=l.shouldSavePayment,[f,k]=s(!1),v=i(null),w=(()=>{const[r,n]=e({}),o=t((e,r)=>{n(n=>({...n,[e]:r}))},[]),a=t(e=>{n(r=>{const n={...r};return delete n[e],n})},[]),s=t(()=>{n({})},[]),i=t(()=>Object.keys(r).length>0,[r]),c=t(e=>r[e]||"",[r]);return{errors:r,setError:o,clearError:a,clearAllErrors:s,hasErrors:i,getError:c}})(),E=((r={})=>{const n=r.pattern||/^[A-Za-zÀ-ú\s-]{5,50}$/,[o,a]=e(""),[s,i]=e(""),[c,l]=e(!1),d=t((e=o)=>{if(!e||!n.test(e)){const e=r.errorMessage||"Invalid cardholder name";return i(e),!1}return i(""),!0},[o,n,r.errorMessage]),u=t(e=>{const r=e.target.value;a(r),c&&d(r)},[c,d]),m=t(()=>{l(!0),d()},[d]);return{value:o,error:s,touched:c,isValid:!s&&c,handleChange:u,handleBlur:m,validate:d,reset:()=>{a(""),i(""),l(!1)}}})({errorMessage:h.nameErrorString,pattern:/^[A-Za-zÀ-ú\s-]{5,50}$/}),S=(o=>{const[a,s]=e(!1),[i,c]=e(""),[l,d]=e(!1),[u,m]=e(null),[p,h]=e(!1),g=n(null),y=n(null),f=n(!1),k=t(()=>{if("undefined"==typeof monei||!monei.CardInput)return void c("MONEI SDK is not available");if(!y.current)return void c("Card input container not found");const e={input:{color:"hsla(0,0%,7%,.8)",fontSize:"16px",boxSizing:"border-box","::placeholder":{color:"hsla(0,0%,7%,.8)"},"-webkit-autofill":{backgroundColor:"#FAFFBD"}},invalid:{color:"#fa755a"}};try{const r=monei.CardInput({accountId:o.accountId,sessionId:o.sessionId,language:o.language,style:e,onFocus(){y.current&&y.current.classList.add("is-focused")},onBlur(){y.current&&y.current.classList.remove("is-focused")},onChange(e){e.isTouched&&e.error?(c(e.error),d(!1),y.current&&y.current.classList.add("is-invalid")):(c(""),e.isTouched&&d(!0),y.current&&y.current.classList.remove("is-invalid"))},onEnter(){g.current&&v().catch(e=>{console.error("Token creation failed on Enter:",e)})}});r.render(y.current),g.current=r,s(!0),c("")}catch(e){c(e.message||"Failed to initialize card input"),s(!1)}},[o]),v=t(async()=>{if(!g.current||!monei?.createToken)return c("Card input not initialized"),null;h(!0),c("");try{const e=await monei.createToken(g.current);return e.error?(c(e.error),null):(m(e.token),e.token)}catch(e){return c(e.message||"Token creation failed"),null}finally{h(!1)}},[]),w=t(()=>{g.current&&g.current.clear&&g.current.clear(),m(null),c(""),d(!1)},[]);return r(()=>{if(!f.current){const e=setTimeout(()=>{k(),f.current=!0},500);return()=>clearTimeout(e)}},[]),r(()=>()=>{if(g.current&&g.current.destroy)try{g.current.destroy()}catch(e){}},[]),{isReady:a,error:i,isValid:l,token:u,isCreatingToken:p,containerRef:y,createToken:v,reset:w}})({accountId:h.accountId,sessionId:h.sessionId,language:h.language});if(g)return(0,o.jsx)("div",{className:"wc-block-components-text-input wc-block-components-address-form__email",children:(0,o.jsx)("p",{children:h.redirected})});const x=i(null),I=c(async()=>(x.current||(x.current=S.createToken().then(e=>(e&&(v.current=e),e)).finally(()=>{x.current=null})),x.current),[S]);return c(()=>{let e=!0;return E.validate()||(e=!1),S.isValid?w.clearError("card"):(w.setError("card",h.cardErrorString),e=!1),e},[E,S.isValid,w,h.cardErrorString]),a(()=>m(async()=>E.validate()?S.error?{errorMessage:S.error}:S.isValid?!!(v.current||S.token||await I())||{errorMessage:h.tokenErrorString}:{errorMessage:h.cardErrorString}:{errorMessage:E.error}),[m,E,S,I,h.cardErrorString,h.tokenErrorString]),a(()=>u(async()=>{k(!0);try{const e=v.current||S.token||await I();return e?{type:d.SUCCESS,meta:{paymentMethodData:{monei_payment_token:e,monei_cardholder_name:E.value,monei_is_block_checkout:"yes"}}}:{type:d.ERROR,message:h.tokenErrorString}}finally{k(!1)}}),[u,E.value,S.token,I,d,h.tokenErrorString]),a(()=>p(async({processingResponse:e})=>{const{paymentDetails:r}=e;if(!r?.paymentId)return console.error("No paymentId found in paymentDetails"),!1;try{if("FAILED"===(await monei.confirmPayment({paymentId:r.paymentId,paymentToken:r.token,paymentMethod:{card:{cardholderName:E.value}}})).status){const e=new URL(r.failUrl);e.searchParams.set("status","FAILED"),window.location.href=e.toString()}else{let e=r.completeUrl;if(!0===y){const{orderId:n,paymentId:t}=r,o=new URL(r.completeUrl);o.searchParams.set("id",t),o.searchParams.set("orderId",n),e=o.toString()}window.location.href=e}}catch(e){console.error("Error during payment confirmation:",e),window.location.href=r.failUrl}return!0}),[p,E.value,y]),(0,o.jsxs)("fieldset",{className:"monei-fieldset monei-card-fieldset wc-block-components-form",children:[h?.description&&(0,o.jsx)("p",{children:h.description}),(0,o.jsxs)("div",{className:"monei-input-container wc-block-components-text-input",children:[(0,o.jsx)("input",{type:"text",id:"cardholder_name",name:"cardholder_name","data-testid":"cardholder-name-input",placeholder:h.cardholderName,required:!0,className:"monei-input "+(E.error?"has-error":""),value:E.value,onChange:E.handleChange,onBlur:E.handleBlur,disabled:f}),E.error&&(0,o.jsx)("div",{className:"wc-block-components-validation-error",children:E.error})]}),(0,o.jsx)("div",{id:"monei-card-input",className:"monei-card-input",ref:S.containerRef}),(0,o.jsx)("input",{type:"hidden",id:"monei_payment_token",name:"monei_payment_token",value:S.token||""}),S.error&&(0,o.jsx)("div",{className:"wc-block-components-validation-error",children:S.error}),w.getError("card")&&(0,o.jsx)("div",{className:"wc-block-components-validation-error",children:w.getError("card")})]})},d=e=>(0,o.jsxs)("div",{className:"monei-label-container",children:[(0,o.jsx)("span",{className:"monei-text",children:e.title}),e?.logo&&(0,o.jsx)("div",{className:"monei-logo",children:(0,o.jsx)("img",{src:e.logo,alt:""})})]});!function(){const{registerPaymentMethod:e}=wc.wcBlocksRegistry,{__}=wp.i18n,r=wc.wcSettings.getSetting("monei_data");e({name:"monei",label:(0,o.jsx)(d,{...r}),ariaLabel:__("MONEI Payment Gateway","monei"),content:(0,o.jsx)(l,{}),edit:(0,o.jsx)("div",{children:__("MONEI Payment Form (Edit Mode)","monei")}),canMakePayment:()=>!0,supports:r.supports||{features:["products"],savePaymentMethod:!0}})}()})();